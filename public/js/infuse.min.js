$(document).ready(function(){function i(e){var t=e.height()-(e.find(".modal-header").height()+18+e.find(".modal-footer").height()+30);e.find(".modal-body").height(t)}function u(e,t){e=typeof e!="undefined"?e:"";t=typeof t!="undefined"?t:1;var n={};if(typeof e=="object")n=e,e=n.search;else{n.latitude="";n.longitude="";n.distance=""}e=e=="Search..."?"":e;var r=$(".importModal"),i=r.attr("id");list=r.data("list"),map=r.data("map"),child=r.data("child"),resource=r.data("resource"),loading=r.find(".loading"),modelImportingTo=r.data("model-importing-to"),modelImportingToId=r.data("model-importing-to-id"),foriegnKey=r.data("related-foriegn-key"),parentId=r.data("related-parent-id");loading.show();r.find(".modal-body .importModalAccordion, .modal-body .addedRow").remove();$.ajax({type:"POST",url:window.location.pathname,data:{action:"fetch_import_batch",child:child,resource:resource,search:e,list:list,map:map,pg:t,id:i,modelImportingToId:modelImportingToId,modelImportingTo:modelImportingTo,latitude:n.latitude,longitude:n.longitude,distance:n.distance,foriegnKey:foriegnKey,parentId:parentId},success:function(e,t,n){var r=$(".importModal"),i=r.data("list");if(e.status=="success"){r.find(".loading").hide();if(e.entries.length>0){r.find("table").append(e.entries_html);a(e.pagination,r)}else f(r,i)}else if(e.status=="error"){r.find(".loading").hide();alert(e.flash.message)}n=null,t=null},error:function(e,t,n){}});i=null,list=null,map=null,child=null,resource=null,e=null,loading=null,r=null}function a(e,t){var n=Math.ceil(parseInt(e.count)/parseInt(e.limit));t.find(".loadMoreResultsPrev, .loadMoreResultsNext").data("active_page",e.active_page);parseInt(e.active_page)!=1?t.find(".loadMoreResultsPrev").data("allow",1).parent().removeClass("disabled"):t.find(".loadMoreResultsPrev").data("allow",0).parent().addClass("disabled");e.active_page!=n?t.find(".loadMoreResultsNext").data("allow",1).parent().removeClass("disabled"):t.find(".loadMoreResultsNext").data("allow",0).parent().addClass("disabled");n=null,loadMoreResults=null,e=null,t=null}function f(e,t){e.find(".modal-body .importModalAccordion, .modal-body .addedRow").remove();var n=$("<tr>").addClass("addedRow"),r=$("<td>").attr("colspan",t.length+1).text("No Results.");n.append(r);e.find("table").append(n);n=null,r=null,e=null,pagination=null}window.Infuse={capitaliseFirstLetter:function(e){return this.replaceUnderscore(e.charAt(0).toUpperCase()+e.slice(1))},replaceUnderscore:function(e){return e.replace(/_/g," ")},properName:function(e){return this.replaceUnderscore(this.capitaliseFirstLetter(e))},isFloat:function(e){return+e===e&&(!isFinite(e)||!!(e%1))},isInt:function(e){return e===+e&&isFinite(e)&&!(e%1)},isBlank:function(e){return!e||/^\s*$/.test(e)},confirmAndblockUI:function(e,t){if(confirm("Confirm "+e+"?")){$.blockUI({message:$("."+t).html()});return!0}return!1}};var e=!1;$(".infuseCkeditor").each(function(){var e=$(this);config=e.data("config");typeof window[config]=="undefined"?e.ckeditor():e.ckeditor(window[config])});$(".selectedDateTime").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss",pickerTimeFormat:"hh-mm-tt"});$(".selectedDate").datepicker({dateFormat:"yy-mm-dd"});$(".infuseBoolean").change(function(){var e=$(this).is(":checked"),t=String($(this).attr("name")),n={id:$(this).data("id"),value:e,column_name:t};$.ajax({type:"POST",url:$(this).data("url"),data:n,success:function(e){console.log(e)},error:function(e,t,n){}})});$(".infuseManage").bind("click",function(t){t.preventDefault();var n=$(this);if(n.data("open")==1&&!e){e=!0;$(".infuseSideMenu").animate({left:"-=360px"},500,function(){n.data("open",!1);e=!1})}else if(n.data("open")==0&&!e){e=!0;$(".infuseSideMenu").animate({left:"+=360px"},500,function(){n.data("open",!0);e=!1})}});var t=0;$(".filterColumn").click(function(e){e.preventDefault();t++;var n=$(this),r=$("<input class='filterInput"+t+"' type='text' >");$(".appendFilters").append(r.wrap("<div class='control-group'>"));var i=$(".filterInput"+t).magicSuggest({width:495,name:"filter_"+t,maxSelectioninteger:3,emptyText:"Type here",displayField:"value",value:[n.data("filter-column"),"contains"],data:[{id:n.data("filter-column"),value:n.text()},{id:"contains",value:"contains"},{id:"equals",value:"equals"},{id:"less than",value:"less than"},{id:"greater than",value:"greater than"},{id:"not equal to",value:"not equal to"}]});$(".filtersContainer").slideDown();$(".filterCount").val(t);n.parent().addClass("hide");$(".downloadCSVLink").attr("href",$(".downloadCSVLink").data("filter-download"))});$(".rebuildFiltersThroughJs div").each(function(){t++;var e=$(this),n=e.data("filter-"+t+"-first"),r=e.data("filter-"+t+"-second"),i=e.data("filter-"+t+"-third"),s=e.data("filter-"+t+"-first-display"),o=$("<input class='filterInput"+t+"' type='text' >");$(".appendFilters").append(o.wrap("<div class='control-group'>"));var u=$(".filterInput"+t).magicSuggest({width:495,name:"filter_"+t,maxSelectioninteger:3,emptyTextstring:"Type here",displayField:"value",value:[n,r,i],data:[{id:n,value:s},{id:"contains",value:"contains"},{id:"equals",value:"equals"},{id:"less than",value:"less than"},{id:"greater than",value:"greater than"},{id:"not equal to",value:"not equal to"},{id:i,value:i}]});$(".filtersContainer").slideDown();$(".filterCount").val(t);$(".filter"+n).parent().addClass("hide");$(".downloadCSVLink").attr("href",$(".downloadCSVLink").data("filter-download"))});$(".clearFilters").click(function(e){$(".appendFilters").empty();$(".filtersForm").submit()});$(".imageCrop").click(function(){var e=$(this),t=e.parent();id=e.data("id"),path=e.data("path"),width=e.data("width"),height=e.data("height"),loaderHtml='<div class="loader bubblingG"><span id="bubblingG_1"></span><span id="bubblingG_2"></span><span id="bubblingG_3"></span></div> ',imagePreviewCrop=e.next(".imagePreviewCrop");imagePreviewCrop.fadeIn();t.find(".imagePreviewCropOn").prop("disabled",!0).hide();e.hide();var n={uploadUrl:path,uploadData:{action:"upload_temp_image"},cropUrl:path,cropData:{action:"crop_image_send_back_url"},modal:!0,imgEyecandyOpacity:.4,loaderHtml:loaderHtml,width:width,height:height,onAfterImgCrop:function(){imagePreviewCrop.height(200);$("#"+id+"CroppedImage").val(t.find("#"+id+" .croppedImg").attr("src"))},afterCropControlRemoveCroppedImage:function(){imagePreviewCrop.height(30);imagePreviewCrop.hide();e.show();t.find(".imagePreviewCropOn").prop("disabled",!1).show();$("#"+id+"CroppedImage").val("")}},r=new Croppic(id,n);$("."+id+"_imgUploadForm").find('input[type="file"]').trigger("click")});$(".childOrderColumn").on("click",".childUpOrder",function(e){e.preventDefault();var t=$(this),n=t.data("id"),r=t.data("url"),i=t.data("model"),s=t.data("column"),o=t.parent().parent().data("class"),u=t.closest("tr"),a=u.prev().find(".childUpOrder").data("id");$("tr."+o).index(t.parent().parent())!=0&&$.ajax({type:"POST",url:r,data:{action:"swap_order",column:s,prevId:a,id:n,model:i,column:s},success:function(e){e.success?u.prev().insertAfter(u):alert("Failed to reorder entries.")},error:function(e,t,n){}});return!1});$(".childOrderColumn").on("click",".childDownOrder",function(e){e.preventDefault();var t=$(this),n=t.data("id"),r=t.data("url"),i=t.data("model"),s=t.data("column"),o=t.closest("tr"),u=o.next().find(".childUpOrder").data("id");o.next().length>0&&$.ajax({type:"POST",url:r,data:{action:"swap_order",column:s,prevId:u,id:n,model:i,column:s},success:function(e){e.success?o.insertAfter(o.next()):alert("Failed to reorder entries.")},error:function(e,t,n){}});return!1});var n=0,r=[];$(".multiSelect").each(function(){n++;var e=$(this),t=e.data("data"),i=e.data("name"),s=String(e.data("value"));if(s.indexOf(",")!==-1){var o=new Array;$.each(s.split(","),function(e,t){o.push(parseInt(t))});s=o}else{var o=new Array;o[0]=parseInt(s);s=o}r[i]=e.magicSuggest({width:495,allowFreeEntries:!1,name:i+n,emptyText:"Click arrow to add",displayField:"value",value:s,data:t});$(r[i]).on("selectionchange",function(e,t,n){$(".multiSelect"+i).val(r[i].getValue())})});$(".placeholder").placeholder();$(".focusPassword").focus(function(){$(this).attr("type","password")});$(".placeholder").placeholder();$(".infuseLogin form").submit(function(){var e=$(this).validate({errorClass:"errorInput"});return e.bool});setTimeout(function(){$.ajax({type:"POST",url:window.location.href,data:{action:"clean_temp_folder"},success:function(e){e.status=="success"},error:function(e,t,n){}})},1e3);var s=$(".importModal"),o="form.search";s.on("show",function(){var e=$(this);if(parseInt(e.data("first"))){e.data("first",0);u("",1)}});s.on("shown",function(){var e=$(this);i(e);$(window).resize(function(){i(e)})});s.on("hide",function(){var e=$(this);e.find(".modal-body .importModalAccordion, .modal-body .addedRow").remove();e.data("first",1);e.find(" .searchBox .searchInput").val("")});s.find(".loadMoreResultsPrev").on("click",function(e){var t=$(this);e.preventDefault();if(parseInt(t.data("allow"))==1)if(o=="form.search"){var n=s.find(" .searchBox form.search  .searchInput").val();u(n,parseInt(t.data("active_page"))-1)}else if(o=="form.advancedSearch"){var r={},i=null;r.search=s.find(".searchField").val(),r.distance=parseInt(s.find(".distance").val()),i=s.find(".searchLatitudeLongitude").val();if(!Infuse.isInt(r.distance)){alert("Distance must be an integer.");return!1}if(i.indexOf(",")==-1){alert("Latitude & Longitude format inccorect don't forget the comma.");return!1}i=i.split(",");r.latitude=parseFloat(i[0]);r.longitude=parseFloat(i[1]);if(!Infuse.isFloat(r.latitude)||!Infuse.isFloat(r.longitude)){alert("Latitude & Longitude must be numbers.");return!1}o="form.advancedSearch";u(r,parseInt(t.data("active_page"))-1)}});s.find(".loadMoreResultsNext").on("click",function(e){var t=$(this);e.preventDefault();if(parseInt(t.data("allow"))==1)if(o=="form.search"){var n=s.find(" .searchBox form.search  .searchInput").val();u(n,parseInt(t.data("active_page"))+1)}else if(o=="form.advancedSearch"){var r={},i=null;r.search=s.find(".searchField").val(),r.distance=parseInt(s.find(".distance").val()),i=s.find(".searchLatitudeLongitude").val();if(!Infuse.isInt(r.distance)){alert("Distance must be an integer.");return!1}if(i.indexOf(",")==-1){alert("Latitude & Longitude format inccorect don't forget the comma.");return!1}i=i.split(",");r.latitude=parseFloat(i[0]);r.longitude=parseFloat(i[1]);if(!Infuse.isFloat(r.latitude)||!Infuse.isFloat(r.longitude)){alert("Latitude & Longitude must be numbers.");return!1}o="form.advancedSearch";u(r,parseInt(t.data("active_page"))+1)}});s.find(" .searchBox form").submit(function(e){e.preventDefault();var t=$(this);if(t.hasClass("search")){var n=t.find(".searchInput").val();o="form.search";u(n,1)}else if(t.hasClass("advancedSearch")){var r={},i=null;r.search=t.find(".searchField").val(),r.distance=parseInt(t.find(".distance").val()),i=t.find(".searchLatitudeLongitude").val();if(!Infuse.isInt(r.distance)){alert("Distance must be an integer.");return!1}if(i.indexOf(",")==-1){alert("Latitude & Longitude format inccorect don't forget the comma.");return!1}i=i.split(",");r.latitude=parseFloat(i[0]);r.longitude=parseFloat(i[1]);if(!Infuse.isFloat(r.latitude)||!Infuse.isFloat(r.longitude)){alert("Latitude & Longitude must be numbers.");return!1}o="form.advancedSearch";u(r,1)}});$(document).on("click",".addedRow",function(){var e=$(this);$(".iconImportAccordion").removeClass("icon-chevron-down").addClass("icon-chevron-right");e.find(".iconImportAccordion").addClass("icon-chevron-down");$(".importModalAccordion").hide();e.next(".importModalAccordion").slideDown()});$(document).on("click",".importEntry",function(e){e.preventDefault();var t=$(this),n=t.data("modal-id"),r=t.closest(".importModalAccordion").find("input:checked"),i=$(".editCreateForm"),s=new Array;$.each(r,function(){var e=$(this),t=e.data("value"),n=e.data("overite-column"),r=e.data("attachment");if(r=="image"){var o=n.split("@");n=o[0];i.find(".importReplace"+n).attr("type","text").val(t)}else if(String(r).indexOf("combine_")>-1){var o=n.split("@");n=o[0],combineColumn=o[1].split("_"),combineColumn=combineColumn[1];combineColumn in s?s[combineColumn].push(n+"#"+t):s[combineColumn]=new Array(n+"#"+t)}else if(r=="convert_text"){var o=n.split("@");n=o[0],newInput=null,oldInput=i.find(".importReplace"+n);$(".importRemove"+n).remove();if(n in s){t=n+"#"+t;for(var u in s[n])t=t+"|"+s[n][u]}oldInput.is("input")?i.find(".importReplace"+n).attr("type","text").val(t):oldInput.is("select")&&i.find(".importReplace"+n).find("option").remove().end().append('<option value="'+t+'">'+t+"</option>").val(t)}else i.find(".importReplace"+n).val(t)});$("#"+n).modal("hide");var o=$("<div>").addClass("alert alert-success"),u=$("<button>").addClass("close").attr("type","button").data("dismiss","alert").html("&times;").on("click",function(){$(this).parent().remove()}),a=$("<h4>").text("Successfully imported fields.");o.append(u).append(a);$(".page-header").append(o)});$(".oneRolePerUser").change(function(){var e=$(this);this.checked&&$(".oneRolePerUser").not(e).prop("checked",!1)});$(".editCreateForm form").submit(function(e){var t=$(".saveSubmitButton");t.attr("disabled",!0)});$(".saveSubmitButton").click(function(){var e=$(this).data("type-submit");$("input[data-type-submit="+e+"]").val("SAVING..");document.getElementById("typeSubmit").value=e});$(document).on("click",".importCheckAll",function(e){e.preventDefault();var t=$(this),n=t.data("all-on")==1?!0:!1,r=t.parent().parent().parent().find(".checkAll");if(n){r.prop("checked",!1);t.data("all-on",0);t.text("Check All")}else{r.prop("checked",!0);t.data("all-on",1);t.text("Uncheck All")}})});